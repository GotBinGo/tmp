<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=windows-1252"><style>
			body
			{
				margin:0;
			}
			#bottom 
			{
				border: 2px solid;
				width: calc(100% - 30px);
				height: 215px;
				position: absolute;
				bottom: 15px;
				left: 15px;
				background-color:rgb(200,200,200);
			}
			#info_area
			{
				border-right: 1px solid;
				width: 200px;
				height: 100%;
				position: absolute;
				bottom: 0px;
				min-height: 100px;
				max-width: 300px;
				background-color:gray;
			}
			#chat
			{
				width: calc(100% - 200px);
				position: absolute;
				height: 100%;
				right: 0px;
				background-color: rgb(210,210,210);
			}
			#messages
			{
				position: absolute;
				top: 0px;
				padding: 0px;
				left: 3px;
				height: calc(100% - 23px);
				width: calc(100% - 3px);
				background-color: rgb(210,210,210);
				overflow-y: scroll;
			}
			#main
			{	
				position: absolute;
				top: 15px;
				left: 15px;
				height: calc(100% - 350px);				
				width: calc(100% - 30px);
				background-color: rgb(0,210,210);	
				border: 2px solid;				
			}
		</style>
		<script>
			var pageleave = false;
			window.addEventListener("beforeunload", function (event) {
				pageleave = true;
			});
			function printMessage(message)
			{
				var on_bottom = false;
				//console.log(d_messages.scrollTop + parseInt(window.getComputedStyle(d_messages, null).getPropertyValue("height"))+" "+ d_messages.scrollHeight);
				if(d_messages.scrollTop + 10 + parseInt(window.getComputedStyle(d_messages, null).getPropertyValue("height")) >= d_messages.scrollHeight)
					on_bottom = true;
				
				var new_span = document.createElement("SPAN");
				var new_br = document.createElement('br');
				new_span.style.display = "inline-block";
				new_span.style.height = "17px";
				new_span.textContent = message;
				d_messages.appendChild(new_span);
				d_messages.appendChild(new_br);	
				if(on_bottom)
					d_messages.scrollTop = d_messages.scrollHeight;
			}
			var sent = [];
			var currup = 0;
			function sendinp ()
			{				
				if(inp.value != "")
				{
					ws.send(inp.value);			
					currup = 0;
					sent.push(inp.value)
					inp.value = "";
					document.getElementById('inp').focus()
					return false;
				}
			}
			var d_messages;
			var dcd;
			window.onload = function()
			{
				d_messages = document.getElementById('messages');
				var start = function () {
					window.open = false;	
					var wsImpl = window.WebSocket || window.MozWebSocket;           
					//window.ws = new wsImpl('ws://s13.webtar.hu:80/');
					window.ws = new wsImpl('ws://localhost:80/');

					ws.onmessage = function (evt) 
					{
						//pre.innerHTML += evt.data; 
						printMessage(evt.data);
					};
					ws.onopen = function () {
						printMessage("Connected");
						dcd = false;
						window.open = true;
					};

					ws.onclose = function () {
						if(dcd === undefined)							
							printMessage("Unable to connect, reconnecting...");																		
						else if(!dcd)							
							printMessage("Disconnected, reconnecting...");																		
						dcd = true;
						if (!pageleave)
							start();		
					};       


				}
				start();
				window.addEventListener("keydown",onKeyDown);
				function onKeyDown(e){
					if(e.keyCode == 13)
					{			
						if(document.activeElement.id == "inp")
							sendinp();
					}
					if(e.keyCode == 38)
					{			
						if(currup < sent.length)
						{
							currup++;				
							inp.value = sent[sent.length-currup];
						}
						e.preventDefault();
					}
					if(e.keyCode == 40)
					{			
						if(currup > 1)
						{
							currup--;			
							inp.value = sent[sent.length-currup];
						}						
					}					
				}

				//d_messages.innerHTML = "asd";
			}
			function getSelectionText() 
			{
				var text = "";
				if (window.getSelection) {
				text = window.getSelection().toString();
				} else if (document.selection && document.selection.type != "Control") {
					text = document.selection.createRange().text;
				}
				return text;
			}
			function mf(input)
			{
				if(getSelectionText() == "")
				document.getElementById('inp').focus();	
			}
		</script>
	</head>
	<body>
		<div id="main">
			<div id="container" style="width:100%; height: 100%; overflow-y: scroll;">
			
			</div>
		</div>
		<div id="bottom" style="height: 300px;">
			<div style="" id="info_area">
			</div>
			<div id="chat" >	
				<div id="messages" onclick="mf(this);">	
				</div>
				<input id="inp" type="text" style="position: absolute; bottom:0; width:100%; height: 20px; margin: 0px; padding: 0px 3px;">
				<input onclick="sendinp()"type="button" id="sendbutton" value="Send" style="width: 50px; height: 20px; position: absolute; right: 0px; bottom: 0px; margin: 0px; padding: 0px;">
			</div>

		</div>
</body></html>
